{"version":3,"sources":["state/Status.ts","utils.ts","components/Ballot.tsx","components/Candidate.tsx","constants.ts","components/CandidateTable.tsx","components/Election.tsx","state/CalculateState.ts","components/ElectionSelector.tsx","App.tsx","index.tsx"],"names":["Status","formatNumber","value","places","expandedPlaces","Math","pow","round","range","length","Array","from","keys","Ballot","props","ballot","className","votes","map","vote","key","candidateName","status","eliminated","elected","undefined","Candidate","this","candidate","expanded","votesToRender","votesOnLastStage","votesOnCurrentRound","slice","name","index","reduce","acc","React","Component","ELECTIONS","fileName","title","CandidateTable","state","candidates","onClick","setState","Election","election","useState","phase","setPhase","activePhase","phases","info","max","disabled","min","ballots","calculateNewPhase","candidateStateForThisPhase","fill","forEach","find","active","push","console","error","votedCandidate","sort","a","b","positionWhenElected","i","result","newCandidates","newBallots","calculateElection","autoElectQuota","floor","log","cloneDeep","someCandidateElectedThisPhase","activeCandidateVotes","extraVotesToDistribute","votedForElectedCandidate","extraVotesDistributed","activeCandidatesBeforeWinner","candidateToDistributeVotesTo","eliminatedName","eliminatedCandidateName","Error","eliminateCandidate","filter","ElectionSelector","elections","setActiveIndex","activeIndex","App","fullState","setFullState","activeElectionIndex","setActiveElectionIndex","useEffect","fetch","process","response","text","parsed","csvParser","parse","candidateNames","data","match","splitName","split","join","rawBallots","rawBallot","ballotWithoutTimestamp","number","choiceIndex","findIndex","choice","includes","String","getData","activeElection","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"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","file":"static/js/main.84d62086.chunk.js","sourcesContent":["export enum Status {\r\n    active,\r\n    elected,\r\n    eliminated,\r\n}\r\n","export const formatNumber = (value: number, places: number): number => {\r\n    const expandedPlaces = Math.pow(10, places);\r\n    return Math.round(value * expandedPlaces) / expandedPlaces;\r\n};\r\n\r\nexport const range = (length: number): number[] => Array.from(Array(length).keys());\r\n","import React, { ReactElement } from 'react';\r\nimport './components.css';\r\nimport { Ballot as BallotType } from '../state/Ballot';\r\nimport { Status } from '../state/Status';\r\nimport { formatNumber } from '../utils';\r\n\r\nexport interface Props {\r\n    ballot: BallotType;\r\n}\r\n\r\nexport function Ballot(props: Props): ReactElement {\r\n    const { ballot } = props;\r\n    return (\r\n        <div className=\"Ballot\">\r\n            <ul>\r\n                {ballot.votes.map((vote) => (\r\n                    <>\r\n                        <li\r\n                            key={vote.candidateName}\r\n                            className={`${\r\n                                vote.status === Status.eliminated\r\n                                    ? 'eliminated'\r\n                                    : vote.status === Status.elected\r\n                                    ? 'elected'\r\n                                    : undefined\r\n                            } animated`}\r\n                        >\r\n                            {vote.candidateName}\r\n                            {vote.value !== 1 ? `(${formatNumber(vote.value, 3)})` : ''}\r\n                        </li>\r\n                        <br />\r\n                    </>\r\n                ))}\r\n            </ul>\r\n        </div>\r\n    );\r\n}\r\n","import React, { ReactElement } from 'react';\r\nimport './components.css';\r\nimport { Candidate as CandidateType } from '../state/Candidate';\r\nimport { Status } from '../state/Status';\r\nimport { formatNumber } from '../utils';\r\n\r\nexport interface Props {\r\n    candidate: CandidateType;\r\n    expanded: boolean;\r\n}\r\n\r\nexport class Candidate extends React.Component<Props> {\r\n    render(): ReactElement {\r\n        const { candidate, expanded } = this.props;\r\n\r\n        let votesToRender = candidate.votesOnLastStage ? candidate.votesOnLastStage : candidate.votesOnCurrentRound;\r\n        if (!expanded) {\r\n            votesToRender = votesToRender.slice(0, 1);\r\n        }\r\n        return (\r\n            <tr\r\n                key={candidate.name}\r\n                className={`${\r\n                    candidate.status === Status.eliminated\r\n                        ? 'eliminated'\r\n                        : candidate.status === Status.elected\r\n                        ? 'elected'\r\n                        : undefined\r\n                } animated`}\r\n            >\r\n                <td>{candidate.name}</td>\r\n                {votesToRender.map((value, index) => (\r\n                    <td key={index}>{formatNumber(value, 3)}</td>\r\n                ))}\r\n                {expanded && <td key={'total'}>{votesToRender.reduce((acc, vote) => acc + vote, 0)}</td>}\r\n            </tr>\r\n        );\r\n    }\r\n}\r\n","export const NUM_ELECTED = 3;\r\nexport const NUM_VOTED = 3;\r\nexport const QUOTA_RATIO = 0.25; // what ratio of the total votes a candidate needs to be automatically elected\r\n\r\nexport const ELECTIONS = [\r\n    {\r\n        fileName: 'Spring_2021.csv',\r\n        title: 'Spring 2021',\r\n    },\r\n    {\r\n        fileName: 'Inaugural_Ballot.csv',\r\n        title: 'Fall 2020',\r\n    },\r\n];\r\n","import React, { ReactElement } from 'react';\r\n\r\nimport './components.css';\r\nimport { Candidate as CandidateType } from '../state/Candidate';\r\nimport { Candidate } from './Candidate';\r\nimport { range } from '../utils';\r\nimport { NUM_VOTED } from '../constants';\r\n\r\nexport interface Props {\r\n    candidates: CandidateType[];\r\n}\r\n\r\nexport interface State {\r\n    expanded: boolean;\r\n}\r\n\r\nexport class CandidateTable extends React.Component<Props, State> {\r\n    constructor(props: Props) {\r\n        super(props);\r\n        this.state = {\r\n            expanded: false,\r\n        };\r\n    }\r\n\r\n    render(): ReactElement {\r\n        const { candidates } = this.props;\r\n        const { expanded } = this.state;\r\n        let votesToRender = range(NUM_VOTED);\r\n        if (!expanded) {\r\n            votesToRender = votesToRender.slice(0, 1);\r\n        }\r\n        return (\r\n            <div className=\"candidateTableWrapper\">\r\n                <table className=\"candidateTable\">\r\n                    <tr>\r\n                        <th>Candidate</th>\r\n                        {votesToRender.map((index) => (\r\n                            <th key={index}>{`Rank ${index + 1} votes`}</th>\r\n                        ))}\r\n                        {expanded && <th>Total</th>}\r\n                    </tr>\r\n                    {candidates.map((candidate) => (\r\n                        <Candidate key={candidate.name} candidate={candidate} expanded={this.state.expanded} />\r\n                    ))}\r\n                </table>\r\n\r\n                <button\r\n                    className=\"expandButton\"\r\n                    onClick={(): void => this.setState({ expanded: !this.state.expanded })}\r\n                >\r\n                    {this.state.expanded ? '<' : '...'}\r\n                </button>\r\n            </div>\r\n        );\r\n    }\r\n}\r\n","import React, { ReactElement, useState } from 'react';\r\n\r\nimport { Ballot } from './Ballot';\r\nimport { Election as ElectionType } from './../state/Election';\r\nimport { CandidateTable } from './CandidateTable';\r\n\r\ninterface Props {\r\n    election: ElectionType;\r\n}\r\n\r\nexport function Election(props: Props): ReactElement {\r\n    const { election } = props;\r\n    const [phase, setPhase] = useState<number>(0);\r\n\r\n    function incrementPhase(): void {\r\n        setPhase(Math.min(election.phases.length - 1, phase + 1));\r\n    }\r\n\r\n    function decrementPhase(): void {\r\n        setPhase(Math.max(0, phase - 1));\r\n    }\r\n\r\n    const activePhase = election.phases[phase];\r\n    return (\r\n        <>\r\n            <div>{activePhase && <CandidateTable candidates={activePhase.candidates}></CandidateTable>}</div>\r\n            <div className=\"info\">{activePhase && activePhase.info}</div>\r\n            <div>\r\n                <button onClick={decrementPhase} disabled={phase === 0}>\r\n                    Previous phase\r\n                </button>\r\n                <button onClick={incrementPhase} disabled={phase === election.phases.length - 1}>\r\n                    Next phase\r\n                </button>\r\n            </div>\r\n            <div>\r\n                {election.phases[phase] &&\r\n                    election.phases[phase].ballots.map((ballot, index) => <Ballot key={index} ballot={ballot} />)}\r\n            </div>\r\n        </>\r\n    );\r\n}\r\n","import cloneDeep from 'lodash.clonedeep';\r\n\r\nimport { NUM_ELECTED, NUM_VOTED, QUOTA_RATIO } from '../constants';\r\nimport { Ballot, Vote } from './Ballot';\r\nimport { Candidate } from './Candidate';\r\nimport { Phase } from './Election';\r\nimport { Status } from './Status';\r\n\r\nfunction calculateNewPhase(\r\n    candidates: Candidate[],\r\n    ballots: Ballot[]\r\n): { newCandidates: Candidate[]; newBallots: Ballot[] } {\r\n    const candidateStateForThisPhase = candidates.map((candidate) => ({\r\n        ...candidate,\r\n        votesOnCurrentRound: Array(NUM_VOTED).fill(0),\r\n    }));\r\n    ballots.forEach((ballot) => {\r\n        const preferences = ballot.votes.reduce((acc, vote) => {\r\n            const candidate = candidateStateForThisPhase.find((candidate) => candidate.name === vote.candidateName);\r\n            if (!candidate) {\r\n                console.error(\r\n                    `Something went horribly wrong, trying to assing a vote to candidate ${vote.candidateName}, but it was not found on the candidate list`\r\n                );\r\n            } else if (vote.status === Status.active) {\r\n                acc.push(vote);\r\n            }\r\n            return acc;\r\n        }, new Array<Vote>());\r\n        preferences.forEach((vote, index) => {\r\n            const votedCandidate = candidateStateForThisPhase.find(\r\n                (candidate) => candidate.name === vote.candidateName\r\n            );\r\n            if (votedCandidate) {\r\n                votedCandidate.votesOnCurrentRound[index] += vote.value;\r\n            } else {\r\n                // doing this mostly to keep the very strict eslint happy\r\n                console.error(\r\n                    `Something went horribly wrong, trying to assing a vote to candidate ${vote.candidateName}, but it was not found on the candidate list`\r\n                );\r\n            }\r\n        });\r\n    });\r\n\r\n    candidateStateForThisPhase.sort((a, b) => {\r\n        if (a.positionWhenElected !== undefined && b.positionWhenElected !== undefined) {\r\n            return a.positionWhenElected - b.positionWhenElected;\r\n        }\r\n        if (a.positionWhenElected !== undefined && b.positionWhenElected === undefined) {\r\n            return -1;\r\n        }\r\n        if (a.positionWhenElected === undefined && b.positionWhenElected !== undefined) {\r\n            return 1;\r\n        }\r\n        for (let i = 0; i < a.votesOnCurrentRound.length; ++i) {\r\n            const result = b.votesOnCurrentRound[i] - a.votesOnCurrentRound[i];\r\n            if (result !== 0) {\r\n                return result;\r\n            }\r\n        }\r\n        return 0;\r\n    });\r\n    return { newCandidates: candidateStateForThisPhase, newBallots: ballots };\r\n}\r\n\r\nfunction eliminateCandidate(phase: Phase): string {\r\n    let eliminatedCandidateName: string | null = null;\r\n    for (let i = phase.candidates.length - 1; i >= 0; --i) {\r\n        if (phase.candidates[i].status === Status.active) {\r\n            eliminatedCandidateName = phase.candidates[i].name;\r\n            phase.candidates[i].status = Status.eliminated;\r\n            phase.candidates[i].votesOnLastStage = phase.candidates[i].votesOnCurrentRound;\r\n            break;\r\n        }\r\n    }\r\n\r\n    if (!eliminatedCandidateName) {\r\n        throw Error('Something went really wrong, no candidate could be eliminated');\r\n    } else {\r\n        phase.ballots.forEach((ballot) => {\r\n            ballot.votes.forEach((vote) => {\r\n                if (vote.candidateName === eliminatedCandidateName) {\r\n                    vote.status = Status.eliminated;\r\n                }\r\n            });\r\n        });\r\n\r\n        return eliminatedCandidateName;\r\n    }\r\n}\r\n\r\nexport const calculateElection = (candidates: Candidate[], ballots: Ballot[]): Phase[] => {\r\n    const autoElectQuota = Math.floor(ballots.length * QUOTA_RATIO) + 1; // strictly higher than the ratio\r\n    console.log(`Any candidate with ${autoElectQuota} votes or more is automatically elected`);\r\n\r\n    const phases: Phase[] = [];\r\n\r\n    const { newCandidates, newBallots } = calculateNewPhase(candidates, ballots);\r\n\r\n    phases.push({\r\n        candidates: newCandidates,\r\n        ballots: newBallots,\r\n        info: `Any candidate with ${autoElectQuota} votes or more is automatically elected`,\r\n    });\r\n\r\n    while (\r\n        phases[phases.length - 1].candidates.filter((candidate) => candidate.status === Status.elected).length <\r\n        NUM_ELECTED\r\n    ) {\r\n        console.log('Phase', phases.length, 'starting');\r\n        const phase = cloneDeep(phases[phases.length - 1]);\r\n        let someCandidateElectedThisPhase = false;\r\n\r\n        for (let i = 0; i < phase.candidates.length && !someCandidateElectedThisPhase; ++i) {\r\n            const candidate = phase.candidates[i];\r\n            const activeCandidateVotes = candidate.votesOnCurrentRound[0];\r\n            if (candidate.status !== Status.elected && activeCandidateVotes >= autoElectQuota) {\r\n                phase.candidates[i].status = Status.elected;\r\n                phase.candidates[i].votesOnLastStage = candidate.votesOnCurrentRound;\r\n                phase.candidates[i].positionWhenElected = i;\r\n                someCandidateElectedThisPhase = true;\r\n                console.log(`${candidate.name} elected!`);\r\n                const extraVotesToDistribute = (activeCandidateVotes - autoElectQuota) / activeCandidateVotes;\r\n                phase.ballots.forEach((ballot) => {\r\n                    let votedForElectedCandidate = false;\r\n                    let extraVotesDistributed = false;\r\n                    let activeCandidatesBeforeWinner = false;\r\n                    ballot.votes.forEach((vote) => {\r\n                        if (votedForElectedCandidate && !extraVotesDistributed) {\r\n                            const candidateToDistributeVotesTo = phase.candidates.find(\r\n                                (candidate) => candidate.name === vote.candidateName\r\n                            );\r\n                            if (candidateToDistributeVotesTo && candidateToDistributeVotesTo.status === Status.active) {\r\n                                vote.value = extraVotesToDistribute;\r\n                                extraVotesDistributed = true;\r\n                            }\r\n                        }\r\n                        if (vote.candidateName === candidate.name) {\r\n                            vote.status = Status.elected;\r\n                            if (!activeCandidatesBeforeWinner) {\r\n                                votedForElectedCandidate = true;\r\n                            }\r\n                        }\r\n                        if (vote.candidateName !== candidate.name && vote.status === Status.active) {\r\n                            activeCandidatesBeforeWinner = true;\r\n                        }\r\n                    });\r\n                });\r\n\r\n                const { newCandidates, newBallots } = calculateNewPhase(phase.candidates, phase.ballots);\r\n                phases.push({\r\n                    candidates: newCandidates,\r\n                    ballots: newBallots,\r\n                    info: `${candidate.name} had more than ${autoElectQuota} votes, so they were elected!`,\r\n                });\r\n            }\r\n        }\r\n\r\n        if (!someCandidateElectedThisPhase) {\r\n            const eliminatedName = eliminateCandidate(phase);\r\n\r\n            const { newCandidates, newBallots } = calculateNewPhase(phase.candidates, phase.ballots);\r\n            phases.push({\r\n                candidates: newCandidates,\r\n                ballots: newBallots,\r\n                info: `${eliminatedName} had the least votes, so they were eliminated!`,\r\n            });\r\n        }\r\n    }\r\n    return phases;\r\n};\r\n","import React, { ReactElement } from 'react';\r\nimport { Election as ElectionType } from './../state/Election';\r\n\r\ninterface Props {\r\n    elections: ElectionType[];\r\n    activeIndex: number;\r\n    setActiveIndex: (index: number) => void;\r\n}\r\n\r\nexport function ElectionSelector(props: Props): ReactElement {\r\n    return (\r\n        <div className=\"electionSelector\">\r\n            <span>\r\n                <h3>Elections</h3>\r\n            </span>\r\n            {props.elections.map((election, index) => (\r\n                <button\r\n                    key={index}\r\n                    onClick={(): void => props.setActiveIndex(index)}\r\n                    disabled={index === props.activeIndex}\r\n                >\r\n                    {election.title}\r\n                </button>\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n","import React, { ReactElement, useEffect, useState } from 'react';\r\nimport csvParser from 'papaparse';\r\n\r\nimport './App.css';\r\nimport { Ballot as BallotType } from './state/Ballot';\r\nimport { Election } from './components/Election';\r\nimport { State } from './state/State';\r\nimport { Status } from './state/Status';\r\nimport { calculateElection } from './state/CalculateState';\r\nimport { range } from './utils';\r\nimport { ELECTIONS, NUM_VOTED } from './constants';\r\nimport { ElectionSelector } from './components/ElectionSelector';\r\n\r\nfunction App(): ReactElement {\r\n    const [fullState, setFullState] = useState<State>({ elections: [] });\r\n    const [activeElectionIndex, setActiveElectionIndex] = useState<number>(0);\r\n    useEffect(() => {\r\n        async function getData(): Promise<void> {\r\n            ELECTIONS.forEach(async ({ fileName, title }, index) => {\r\n                const response = await fetch(`${process.env.PUBLIC_URL}/data/${fileName}`);\r\n                const text = await response.text();\r\n                const parsed = csvParser.parse(text);\r\n\r\n                const candidateNames = (parsed.data[0] as string[]).slice(1);\r\n\r\n                const candidates = candidateNames.map((candidate) => {\r\n                    const match = candidate.match(/\\[(.*)\\]/);\r\n                    const name = match ? match[1] : '';\r\n                    const splitName = name.split(' ');\r\n                    const reorderedName = [\r\n                        splitName[splitName.length - 1],\r\n                        ...splitName.slice(0, splitName.length - 1),\r\n                    ];\r\n                    const finalName = reorderedName.join(' ');\r\n                    return {\r\n                        name: finalName,\r\n                        status: Status.active,\r\n                        votesOnCurrentRound: Array(NUM_VOTED).fill(0),\r\n                    };\r\n                });\r\n\r\n                const rawBallots = (parsed.data as string[][]).slice(1);\r\n                const ballots = rawBallots.map(\r\n                    (rawBallot): BallotType => {\r\n                        const ballotWithoutTimestamp = rawBallot.slice(1);\r\n\r\n                        const rankedCandidateNames = range(NUM_VOTED).map((number) => {\r\n                            const choiceIndex = ballotWithoutTimestamp.findIndex((choice) =>\r\n                                choice.includes(String(number + 1))\r\n                            );\r\n                            const candidateName = candidates[choiceIndex].name;\r\n                            return {\r\n                                candidateName: candidateName,\r\n                                status: Status.active,\r\n                                value: 1,\r\n                            };\r\n                        });\r\n\r\n                        return {\r\n                            votes: rankedCandidateNames,\r\n                        };\r\n                    }\r\n                );\r\n                const phases = calculateElection(candidates, ballots);\r\n                fullState.elections[index] = {\r\n                    title,\r\n                    phases,\r\n                };\r\n                setFullState({ elections: fullState.elections });\r\n            });\r\n        }\r\n        getData();\r\n    }, []);\r\n\r\n    const activeElection = fullState.elections[activeElectionIndex];\r\n    return (\r\n        <div className=\"App\">\r\n            <ElectionSelector\r\n                elections={fullState.elections}\r\n                setActiveIndex={setActiveElectionIndex}\r\n                activeIndex={activeElectionIndex}\r\n            />\r\n            {activeElection && <Election election={activeElection} />}\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default App;\r\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nReactDOM.render(\n    <React.StrictMode>\n        <App />\n    </React.StrictMode>,\n    document.getElementById('root')\n);\n"],"sourceRoot":""}